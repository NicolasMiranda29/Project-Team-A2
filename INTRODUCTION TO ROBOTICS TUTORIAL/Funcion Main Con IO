Function main

    Print "ESPERANDO START (Sw(0))..."
    Wait Sw(0) = On       ' espera a que START esté presionado
    Wait .2          ' espera 0.2 segundos de debounce
    Print "EJECUTANDO MAIN"

    ' =========================
    ' CONFIGURACIÓN DEL ROBOT
    ' =========================
    Motor On
    Power High
    Speed 30
    Accel 30, 30
    SpeedS 1300
    AccelS 5000
    Tool 1

    Tokens = 3
    Blocks = 3
    TokenHeight = 6.0
    BlockHeight = 6.0

    Pallet 1, Local_Tray_Base, P20, P21, 2, 3
    Pallet 2, Local_Infeed, P23, P22, 1, 2

    Integer TokenID
    Integer BlockID

    Go Retract_Safe

    ' =========================
    ' BUCLE DE TOKENS
    ' =========================
    For TokenID = Tokens To 1 Step -1

        ' Supervisión durante la ejecución
        Do
            If Sw(4) = On Then   ' STOP
                Halt main
                Quit main
                Exit Function
            EndIf

            If Sw(5) = On Then   ' PAUSE
                Halt main
            EndIf

            If Sw(6) = On Then   ' CONTINUE
                Resume main
            EndIf

            If Sw(7) = On Then   ' RESET
                Halt main
                Quit main
                ' Volver a inicio de main
                main
            EndIf

     '        Salir del bucle de supervisión si todo normal
            Exit Do
        Loop

        Pick_Infeed_Token()
        Alignment_Token()

        TokenRow = 2
        TokenCol = TokenID

        Place_Tray_Token
    Next TokenID

    ' =========================
    ' BUCLE DE BLOCKS
    ' =========================
    For BlockID = Blocks To 1 Step -1

        ' Supervisión durante la ejecución
        Do
            If Sw(4) = On Then
                Halt main
                Quit main
                Exit Function
            EndIf

            If Sw(5) = On Then
                Halt main
            EndIf

            If Sw(6) = On Then
                Resume main
            EndIf

            If Sw(7) = On Then
                Halt main
                Quit main
                main
            EndIf

            Exit Do
        Loop

        Pick_Infeed_Block()
        Alignment_Block()

        BlockRow = 1
        BlockCol = BlockID

        Place_Tray_Block
    Next BlockID

    Go Retract_Safe

Fend
